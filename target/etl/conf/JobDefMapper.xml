<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ftoul.bi.etl.mapper.JobDefMapper" >
    <resultMap id="JobDefMap" type="com.ftoul.bi.etl.model.JobDef" >
        <result column="JOB_ID" property="jobId" jdbcType="INTEGER" />
        <result column="JOB_NAME" property="jobName" jdbcType="VARCHAR" />
        <result column="CMD_NAM" property="cmdName" jdbcType="VARCHAR" />
        <result column="CMD_PATH" property="cmdPath" jdbcType="VARCHAR" />
        <result column="CMD_TYP" property="cmdType" jdbcType="INTEGER" />
        <result column="JOB_VALID" property="jobValid" jdbcType="INTEGER" />
        <result column="JOB_GROUP" property="jobGroup" jdbcType="INTEGER" />
        <result column="MAX_INSTANCE" property="maxInstance" jdbcType="INTEGER" />
        <result column="PRIORTY" property="priorty" jdbcType="INTEGER" />
        <result column="last_status" property="lastStatus" jdbcType="INTEGER" />
        <result column="last_data_date" property="lastDataDate" jdbcType="VARCHAR" />
    </resultMap>
    <sql id="Base_Column_List" >
        A.JOB_ID,A.JOB_NAME,A.CMD_NAM,A.CMD_PATH,A.CMD_TYP,A.JOB_VALID,A.JOB_GROUP,A.MAX_INSTANCE,A.PRIORTY
    </sql>
    <select id="getById" resultMap="JobDefMap" parameterType="java.lang.Integer" >
        select
        <include refid="Base_Column_List" />
        from t_job_def A
        where job_id = #{jobId,jdbcType=INTEGER}
    </select>
    <select id="getList" resultMap="JobDefMap">
        select
        <include refid="Base_Column_List" />
        from t_job_def A
        where job_valid=1
    </select>

    <select id="getNextJob" resultMap="JobDefMap" >
        select
        <include refid="Base_Column_List" />
        from t_job_def A
              JOIN t_job_ref b on a.job_id=b.job_id
        where b.ref_job_id = #{jobId,jdbcType=INTEGER}
    </select>

    <select id="getPreJob" resultMap="JobDefMap" >
        select
        <include refid="Base_Column_List" />
        from t_job_def A
        JOIN t_job_ref b on a.job_id=b.ref_job_id
        where b.job_id = #{jobId,jdbcType=INTEGER}
    </select>

    <select id="getListForPage" resultMap="JobDefMap" parameterType="HashMap">
        select
        <include refid="Base_Column_List" />
        ,CASE WHEN B.INST_ID IS NULL THEN -1 ELSE B.STATUS END AS last_status
        ,B.DATA_DATE last_data_date
        from t_job_def A
        LEFT JOIN (SELECT A.*,
        IF(@job_id=a.job_id, @rank:=@rank+1,@rank:=1) rank,
        @job_id:=a.job_id
        FROM (
        SELECT A.*
        FROM T_JOB_INST A
        ORDER BY A.job_id, A.START_TIME DESC
        ) A JOIN (Select @job_id:=null, @rank:=1) B) B ON A.job_id=B.job_id AND B.RANK=1
        where A.job_valid=1
        ORDER BY CASE WHEN B.INST_ID IS NULL THEN -1 ELSE B.STATUS END
        limit #{pageIndex}, #{pageSize}
    </select>

    <select id="getCount" resultType="java.lang.Integer" >
        select count(*) from t_job_def a where job_valid=1
    </select>

    <select id="getListForPage2" resultMap="JobDefMap" parameterType="HashMap">
        select
        <include refid="Base_Column_List" />
        from t_job_def A
      Where 1=1
        <if test="jobDef.jobId != null and jobDef.jobId !=0">
            and job_id like concat(#{jobDef.jobId},'%')
        </if>
        order by job_id
        limit #{pageIndex}, #{pageSize}
    </select>

    <select id="getCount2" resultType="java.lang.Integer" parameterType="com.ftoul.bi.etl.model.JobDef">
        select count(*) from t_job_def a
        Where 1=1
        <if test="jobId != null and jobId !=0">
            and job_id like concat(#{jobId},'%')
        </if>
    </select>

    <delete id="delete" parameterType="java.lang.Integer" >
        delete from t_job_def
        where job_id = #{dsId,jdbcType=INTEGER}
    </delete>
    <insert id="add" parameterType="com.ftoul.bi.etl.model.JobDef" >
        insert into t_job_def (JOB_ID,JOB_NAME,CMD_NAM,CMD_PATH,CMD_TYP,JOB_VALID,JOB_GROUP,MAX_INSTANCE,PRIORTY)
        values (#{jobId,jdbcType=INTEGER}, #{jobName,jdbcType=VARCHAR}, #{cmdName,jdbcType=VARCHAR},#{cmdPath, jdbcType=VARCHAR},#{cmdType,jdbcType=INTEGER},
                 #{jobValid, jdbcType=INTEGER},#{jobGroup,jdbcType=VARCHAR},#{maxInstance,jdbcType=INTEGER},#{priorty,jdbcType=INTEGER})
    </insert>

    <update id="update" parameterType="com.ftoul.bi.etl.model.JobDef">
        update t_job_def set
        <trim prefix="" suffix="" suffixOverrides=",">
            <if test="jobName != null">
                job_name=#{jobName, jdbcType=VARCHAR},
            </if>
            <if test="cmdName != null">
                cmd_nam=#{cmdName, jdbcType=VARCHAR},
            </if>
            <if test="cmdPath != null ">
                cmd_path = #{cmdPath, jdbcType=VARCHAR},
            </if>
            <if test="jobValid != null">
                job_valid=#{jobValid, jdbcType=VARCHAR},
            </if>
            <if test="jobGroup != null">
                job_group=#{jobGroup, jdbcType=VARCHAR},
            </if>
            <if test="priorty !=null">
                priorty=#{priorty,jdbcType=INTEGER}
            </if>
        </trim>
        where job_id = #{jobId, jdbcType=INTEGER}
    </update>
</mapper>